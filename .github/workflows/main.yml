name: Build ViiCovers binaries

on:
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    name: Build on Linux

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Install Poetry
      run: |
        curl -sSL https://install.python-poetry.org | python3
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Install dependencies
      run: poetry install --no-interaction --no-root

    - name: Build with PyInstaller
      uses: sayyid5416/pyinstaller@v1
      with:
        spec: ViiCovers.spec
    - name: Pack binary + data into tgz
      run: |
        tar -czvf ViiCovers_bundle.tgz dist/ViiCovers/data dist/ViiCovers/ViiCovers
          
    - name: Upload tgz artifact
      uses: sayyid5416/pyinstaller@v1
      with:
        upload_exe_with_name: ViiCovers_bundle.tgz

  build-windows:
    runs-on: windows-latest
    name: Build on Windows

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Install Poetry
      run: |
        (Invoke-WebRequest -Uri https://install.python-poetry.org -UseBasicParsing).Content | python
      shell: powershell

    - name: Add Poetry to PATH
      run: echo "$env:USERPROFILE\AppData\Roaming\Python\Scripts" >> $env:GITHUB_PATH
      shell: powershell

    - name: Install dependencies
      run: poetry install --no-interaction --no-root
      shell: powershell

    - name: Build with PyInstaller
      uses: sayyid5416/pyinstaller@v1
      with:
        spec: ViiCovers.spec

    - name: Pack exe + data into zip
      run: |
        mkdir upload
        ls
        ls build/
        cp build/ViiCovers.exe upload/
        cp -r build/data upload/
        cd upload
        zip -r ../ViiCovers_bundle.zip .
      
    - name: Upload zip artifact
      uses: sayyid5416/pyinstaller@v1
      with:
        upload_exe_with_name: ViiCovers_bundle.zip


